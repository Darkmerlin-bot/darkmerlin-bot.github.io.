<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2d5a4a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>GlutenFree Kitchen</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--forest:#2d5a4a;--forest-light:#3d7a64;--sage:#87a878;--cream:#faf8f5;--warm-white:#fffef9;--terracotta:#c4785c;--terracotta-light:#e89a7a;--charcoal:#2a2a2a;--text-muted:#666;--danger:#dc3545;--warning:#f0ad4e;--success:#28a745;--shadow-soft:0 4px 20px rgba(45,90,74,0.1);--shadow-medium:0 8px 30px rgba(45,90,74,0.15);--radius-sm:12px;--radius-md:20px;--radius-lg:28px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--charcoal);min-height:100vh}
        .app-container{max-width:480px;margin:0 auto;min-height:100vh;background:var(--warm-white);padding-bottom:100px}
        .header{background:linear-gradient(135deg,var(--forest),var(--forest-light));padding:24px 20px 32px;border-radius:0 0 var(--radius-lg) var(--radius-lg);position:relative;overflow:hidden}
        .header::before{content:'';position:absolute;top:-50%;right:-20%;width:200px;height:200px;background:radial-gradient(circle,rgba(255,255,255,0.1),transparent 70%);border-radius:50%}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .logo{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:white;display:flex;align-items:center;gap:10px}
        .logo-icon{width:36px;height:36px;background:var(--terracotta);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .sync-status{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.15);padding:8px 14px;border-radius:20px;font-size:0.8rem;color:white}
        .sync-dot{width:8px;height:8px;background:#7cfc7c;border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .header-subtitle{color:rgba(255,255,255,0.85);font-size:0.95rem}
        .nav-tabs{display:flex;gap:8px;padding:0 20px;margin-top:-16px;position:relative;z-index:10}
        .nav-tab{flex:1;background:white;border:none;padding:16px 12px;border-radius:var(--radius-md);font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all 0.3s;box-shadow:var(--shadow-soft);display:flex;flex-direction:column;align-items:center;gap:6px}
        .nav-tab.active{background:var(--forest);color:white;transform:translateY(-4px);box-shadow:var(--shadow-medium)}
        .nav-tab-icon{font-size:1.4rem}
        .section{display:none;padding:24px 20px;animation:fadeIn 0.3s}
        .section.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .section-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:600;margin-bottom:20px}
        .search-container{background:white;border-radius:var(--radius-md);padding:20px;margin-bottom:20px;box-shadow:var(--shadow-soft)}
        .search-title{font-weight:600;color:var(--forest);margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .search-form{display:flex;gap:10px}
        .search-input{flex:1;padding:14px 18px;border:2px solid var(--cream);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:1rem}
        .search-input:focus{outline:none;border-color:var(--sage)}
        .search-btn{background:var(--terracotta);border:none;padding:14px 24px;border-radius:var(--radius-sm);color:white;font-weight:600;cursor:pointer}
        .search-btn:hover{background:var(--terracotta-light)}
        .search-btn:disabled{background:#ccc}
        .search-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
        .suggestion-chip{background:var(--cream);border:none;padding:8px 14px;border-radius:20px;font-size:0.85rem;color:var(--forest);cursor:pointer}
        .suggestion-chip:hover{background:var(--sage);color:white}
        .loading-container{display:none;flex-direction:column;align-items:center;padding:40px 20px}
        .loading-container.active{display:flex}
        .loading-spinner{width:50px;height:50px;border:4px solid var(--cream);border-top-color:var(--forest);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{color:var(--text-muted);text-align:center}
        .loading-steps{margin-top:16px}
        .loading-step{display:flex;align-items:center;gap:10px;padding:8px 0;color:var(--text-muted);font-size:0.9rem}
        .loading-step.done{color:var(--success)}
        .loading-step.active{color:var(--forest);font-weight:500}
        .recipe-filters{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:8px}
        .filter-chip{background:var(--cream);border:2px solid transparent;padding:10px 18px;border-radius:25px;font-size:0.85rem;font-weight:500;color:var(--text-muted);cursor:pointer;white-space:nowrap}
        .filter-chip.active{background:var(--sage);color:white}
        .recipe-grid{display:grid;gap:16px}
        .recipe-card{background:white;border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-soft);cursor:pointer}
        .recipe-card:active{transform:scale(0.98)}
        .recipe-card.from-search{border:2px solid var(--sage)}
        .recipe-image{height:140px;background:linear-gradient(135deg,var(--sage),var(--forest-light));display:flex;align-items:center;justify-content:center;font-size:3rem;position:relative}
        .recipe-image.has-img{background-size:cover;background-position:center}
        .recipe-image.has-img span{display:none}
        .recipe-badges{position:absolute;top:10px;right:10px;display:flex;gap:6px;flex-wrap:wrap;max-width:70%;justify-content:flex-end}
        .badge{background:rgba(255,255,255,0.95);padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;color:var(--forest)}
        .badge.carbs{background:var(--terracotta);color:white}
        .badge.ai{background:var(--forest);color:white}
        .badge.warning{background:var(--warning);color:var(--charcoal)}
        .recipe-content{padding:16px}
        .recipe-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;margin-bottom:8px}
        .recipe-meta{display:flex;gap:16px;color:var(--text-muted);font-size:0.8rem;flex-wrap:wrap}
        .recipe-meta span{display:flex;align-items:center;gap:4px}
        .recipe-analysis{margin-top:12px;padding:10px;background:var(--cream);border-radius:var(--radius-sm);font-size:0.85rem}
        .analysis-item{display:flex;justify-content:space-between;padding:4px 0}
        .analysis-value{font-weight:600}
        .analysis-value.good{color:var(--success)}
        .analysis-value.warning{color:var(--warning)}
        .analysis-value.bad{color:var(--danger)}
        .search-results-info{background:var(--cream);padding:16px;border-radius:var(--radius-md);margin-bottom:16px;display:none}
        .search-results-info.active{display:block}
        .results-title{font-weight:600;color:var(--forest);margin-bottom:8px}
        .results-description{font-size:0.9rem;color:var(--text-muted)}
        .clear-search-btn{background:none;border:1px solid var(--forest);padding:8px 16px;border-radius:20px;color:var(--forest);font-size:0.85rem;cursor:pointer;margin-top:12px}
        .clear-search-btn:hover{background:var(--forest);color:white}
        .week-selector{display:flex;gap:6px;margin-bottom:20px;overflow-x:auto}
        .day-btn{flex:1;min-width:50px;background:white;border:2px solid var(--cream);padding:12px 8px;border-radius:var(--radius-sm);text-align:center;cursor:pointer}
        .day-btn.active{background:var(--forest);border-color:var(--forest);color:white}
        .day-btn.has-meals{border-color:var(--sage)}
        .day-name{font-size:0.75rem;font-weight:600;text-transform:uppercase}
        .day-number{font-size:1.1rem;font-weight:600;margin-top:4px}
        .meal-slots{display:flex;flex-direction:column;gap:12px}
        .meal-slot{background:white;border-radius:var(--radius-md);padding:16px;box-shadow:var(--shadow-soft)}
        .meal-slot-header{margin-bottom:12px}
        .meal-type{font-weight:600;color:var(--forest);font-size:0.9rem;display:flex;align-items:center;gap:8px}
        .meal-item{background:var(--cream);padding:12px 16px;border-radius:var(--radius-sm);display:flex;justify-content:space-between;align-items:center}
        .meal-item-name{font-weight:500}
        .remove-meal{background:none;border:none;color:var(--terracotta);font-size:1.2rem;cursor:pointer}
        .empty-slot{border:2px dashed var(--sage);padding:20px;text-align:center;color:var(--text-muted);font-size:0.9rem;border-radius:var(--radius-sm)}
        .shopping-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .generate-list-btn{background:var(--terracotta);border:none;padding:12px 20px;border-radius:25px;color:white;font-weight:600;font-size:0.9rem;cursor:pointer;display:flex;align-items:center;gap:8px}
        .generate-list-btn:hover{background:var(--terracotta-light)}
        .shopping-progress{background:white;border-radius:var(--radius-md);padding:20px;margin-bottom:20px;box-shadow:var(--shadow-soft)}
        .progress-bar{height:8px;background:var(--cream);border-radius:4px;overflow:hidden;margin-bottom:8px}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--sage),var(--forest));border-radius:4px;transition:width 0.3s}
        .progress-text{font-size:0.85rem;color:var(--text-muted);text-align:right}
        .shopping-categories{display:flex;flex-direction:column;gap:16px}
        .shopping-category{background:white;border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-soft)}
        .category-header{background:var(--cream);padding:14px 16px;font-weight:600;display:flex;align-items:center;gap:10px;color:var(--forest)}
        .shopping-items{padding:8px}
        .shopping-item{display:flex;align-items:center;gap:12px;padding:14px 12px;border-radius:var(--radius-sm);cursor:pointer}
        .shopping-item:hover{background:var(--cream)}
        .shopping-item.checked{opacity:0.5}
        .shopping-item.checked .item-name{text-decoration:line-through}
        .checkbox{width:24px;height:24px;border:2px solid var(--sage);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .shopping-item.checked .checkbox{background:var(--sage)}
        .checkbox-icon{color:white;font-size:0.9rem;opacity:0}
        .shopping-item.checked .checkbox-icon{opacity:1}
        .item-name{font-weight:500}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:flex-end;justify-content:center;z-index:100}
        .modal-overlay.active{display:flex}
        .modal{background:white;width:100%;max-width:480px;max-height:85vh;border-radius:var(--radius-lg) var(--radius-lg) 0 0;overflow:hidden;animation:slideUp 0.3s}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{padding:20px;border-bottom:1px solid var(--cream);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:600}
        .modal-close{background:var(--cream);border:none;width:36px;height:36px;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .modal-body{padding:20px;max-height:60vh;overflow-y:auto}
        .recipe-detail-image{height:180px;background:linear-gradient(135deg,var(--sage),var(--forest-light));border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:4rem;margin-bottom:20px;background-size:cover;background-position:center}
        .recipe-detail-badges{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .detail-badge{background:var(--cream);padding:8px 14px;border-radius:20px;font-size:0.8rem;font-weight:500;color:var(--forest)}
        .recipe-section{margin-bottom:24px}
        .recipe-section-title{font-weight:600;color:var(--forest);margin-bottom:12px}
        .ingredients-list{list-style:none}
        .ingredients-list li{padding:10px 0;border-bottom:1px solid var(--cream);display:flex;align-items:center;gap:10px}
        .ingredients-list li::before{content:'‚Ä¢';color:var(--terracotta);font-size:1.2rem}
        .instructions-list{list-style:none}
        .instructions-list li{padding:12px 0;border-bottom:1px solid var(--cream);display:flex;gap:14px;align-items:flex-start}
        .step-number{width:28px;height:28px;background:var(--forest);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:600;flex-shrink:0}
        .modal-footer{padding:20px;border-top:1px solid var(--cream)}
        .modal-btn{width:100%;background:var(--forest);border:none;padding:16px;border-radius:var(--radius-sm);color:white;font-size:1rem;font-weight:600;cursor:pointer}
        .modal-btn:hover{background:var(--forest-light)}
        .day-select-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .day-select-btn{background:var(--cream);border:2px solid transparent;padding:16px;border-radius:var(--radius-sm);text-align:center;cursor:pointer;font-family:'DM Sans',sans-serif}
        .day-select-btn:hover{border-color:var(--sage)}
        .day-select-btn.selected{background:var(--forest);color:white}
        .meal-select-btns{display:flex;flex-direction:column;gap:10px;margin-top:20px}
        .meal-select-btn{background:white;border:2px solid var(--cream);padding:14px;border-radius:var(--radius-sm);text-align:left;cursor:pointer;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:12px}
        .meal-select-btn:hover{border-color:var(--sage);background:var(--cream)}
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
        .empty-state-icon{font-size:4rem;margin-bottom:16px;opacity:0.5}
        .empty-state-text{font-size:1rem;line-height:1.6}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--charcoal);color:white;padding:14px 24px;border-radius:25px;font-size:0.9rem;font-weight:500;z-index:200;opacity:0;transition:all 0.3s;max-width:90%;text-align:center}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.error{background:var(--danger)}
        .toast.success{background:var(--success)}
        .add-item-form{display:flex;gap:10px;margin-bottom:20px}
        .add-item-input{flex:1;padding:14px 18px;border:2px solid var(--cream);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:1rem}
        .add-item-input:focus{outline:none;border-color:var(--sage)}
        .add-item-btn{background:var(--forest);border:none;padding:14px 20px;border-radius:var(--radius-sm);color:white;font-size:1.2rem;cursor:pointer}
        .gluten-alert{background:#fff3cd;border:1px solid var(--warning);padding:12px 16px;border-radius:var(--radius-sm);margin-bottom:16px;display:flex;align-items:flex-start;gap:12px}
        .gluten-alert-icon{font-size:1.5rem}
        .gluten-alert-text{font-size:0.9rem}
        .gluten-alert-title{font-weight:600;margin-bottom:4px}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-top">
                <div class="logo"><div class="logo-icon">üåø</div>GlutenFree</div>
                <div class="sync-status"><div class="sync-dot"></div>Sincronizado</div>
            </div>
            <p class="header-subtitle">Recetas sin gluten y bajas en carbohidratos</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="recipes"><span class="nav-tab-icon">üìñ</span>Recetas</button>
            <button class="nav-tab" data-tab="menu"><span class="nav-tab-icon">üìÖ</span>Men√∫</button>
            <button class="nav-tab" data-tab="shopping"><span class="nav-tab-icon">üõí</span>Compras</button>
        </nav>

        <section id="recipes" class="section active">
            <div class="search-container">
                <h3 class="search-title">üîç Buscar recetas online</h3>
                <div class="search-form">
                    <input type="text" class="search-input" id="searchInput" placeholder="Ej: chicken, salad, beef...">
                    <button class="search-btn" id="searchBtn">Buscar</button>
                </div>
                <div class="search-suggestions">
                    <button class="suggestion-chip" data-query="chicken">üçó Chicken</button>
                    <button class="suggestion-chip" data-query="salad">ü•ó Salad</button>
                    <button class="suggestion-chip" data-query="fish">üêü Fish</button>
                    <button class="suggestion-chip" data-query="beef">ü•© Beef</button>
                    <button class="suggestion-chip" data-query="egg">üç≥ Eggs</button>
                    <button class="suggestion-chip" data-query="soup">üç≤ Soup</button>
                </div>
            </div>
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner"></div>
                <p class="loading-text">Buscando y analizando recetas...</p>
                <div class="loading-steps" id="loadingSteps">
                    <div class="loading-step" data-step="search"><span>üîç</span><span>Buscando recetas</span></div>
                    <div class="loading-step" data-step="analyze"><span>üß™</span><span>Analizando ingredientes</span></div>
                    <div class="loading-step" data-step="filter"><span>‚úÖ</span><span>Filtrando sin gluten y bajo en carbs</span></div>
                </div>
            </div>
            <div class="search-results-info" id="searchResultsInfo">
                <div class="results-title" id="resultsTitle"></div>
                <div class="results-description" id="resultsDescription"></div>
                <button class="clear-search-btn" id="clearSearchBtn">Ver recetas guardadas</button>
            </div>
            <h2 class="section-title">Explora recetas</h2>
            <div class="recipe-filters">
                <button class="filter-chip active" data-filter="all">Todas</button>
                <button class="filter-chip" data-filter="desayuno">Desayuno</button>
                <button class="filter-chip" data-filter="almuerzo">Almuerzo</button>
                <button class="filter-chip" data-filter="cena">Cena</button>
                <button class="filter-chip" data-filter="snack">Snacks</button>
            </div>
            <div class="recipe-grid" id="recipeGrid"></div>
        </section>

        <section id="menu" class="section">
            <h2 class="section-title">Planifica tu semana</h2>
            <div class="week-selector" id="weekSelector"></div>
            <div class="meal-slots" id="mealSlots"></div>
        </section>

        <section id="shopping" class="section">
            <div class="shopping-header">
                <h2 class="section-title">Lista de compras</h2>
                <button class="generate-list-btn" id="generateListBtn"><span>‚ú®</span>Generar lista</button>
            </div>
            <div class="add-item-form">
                <input type="text" class="add-item-input" id="addItemInput" placeholder="Agregar item...">
                <button class="add-item-btn" id="addItemBtn">+</button>
            </div>
            <div class="shopping-progress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
                <p class="progress-text" id="progressText">0 de 0 items</p>
            </div>
            <div class="shopping-categories" id="shoppingCategories"></div>
        </section>
    </div>

    <div class="modal-overlay" id="recipeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Receta</h3>
                <button class="modal-close" id="closeModal">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer"><button class="modal-btn" id="addToMenuBtn">Agregar al men√∫</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="daySelectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Selecciona d√≠a y comida</h3>
                <button class="modal-close" id="closeDayModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="day-select-grid" id="daySelectGrid"></div>
                <div class="meal-select-btns" id="mealSelectBtns">
                    <button class="meal-select-btn" data-meal="desayuno"><span>üåÖ</span> Desayuno</button>
                    <button class="meal-select-btn" data-meal="almuerzo"><span>‚òÄÔ∏è</span> Almuerzo</button>
                    <button class="meal-select-btn" data-meal="cena"><span>üåô</span> Cena</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Base recipes (20 recetas sin gluten y bajas en carbs)
        const baseRecipes = [
            { id: 1, name: "Huevos revueltos con aguacate", category: "desayuno", time: 15, servings: 2, carbs: 4, calories: 320, emoji: "ü•ë", isGlutenFree: true, carbsLevel: "low", ingredients: ["4 huevos", "1 aguacate", "2 cdas mantequilla", "Sal y pimienta", "Ceboll√≠n"], instructions: ["Bate huevos con sal y pimienta", "Derrite mantequilla a fuego medio-bajo", "Revuelve constantemente", "Retira cremosos", "Sirve con aguacate"] },
            { id: 2, name: "Ensalada C√©sar con pollo", category: "almuerzo", time: 25, servings: 2, carbs: 8, calories: 450, emoji: "ü•ó", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 pechugas de pollo", "1 lechuga romana", "50g parmesano", "Aderezo C√©sar sin gluten", "Aceite de oliva"], instructions: ["Sazona y cocina pollo", "Corta lechuga", "Rebana pollo", "A√±ade parmesano y aderezo"] },
            { id: 3, name: "Salm√≥n al horno con esp√°rragos", category: "cena", time: 30, servings: 2, carbs: 6, calories: 520, emoji: "üêü", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 filetes salm√≥n", "1 manojo esp√°rragos", "Aceite de oliva", "Ajo", "Lim√≥n", "Eneldo"], instructions: ["Precalienta horno 200¬∞C", "Coloca salm√≥n y esp√°rragos", "Roc√≠a con aceite y condimentos", "Hornea 15-18 min", "Sirve con lim√≥n"] },
            { id: 4, name: "Omelette de espinacas", category: "desayuno", time: 10, servings: 1, carbs: 3, calories: 280, emoji: "üç≥", isGlutenFree: true, carbsLevel: "low", ingredients: ["3 huevos", "1 taza espinacas", "30g queso de cabra", "Mantequilla", "Sal y pimienta"], instructions: ["Bate huevos", "Derrite mantequilla", "Vierte huevos", "A√±ade espinacas y queso", "Dobla y sirve"] },
            { id: 5, name: "Tacos de lechuga con carne", category: "almuerzo", time: 20, servings: 4, carbs: 5, calories: 380, emoji: "ü•¨", isGlutenFree: true, carbsLevel: "low", ingredients: ["500g carne molida", "8 hojas lechuga", "1 cebolla", "2 tomates", "Cilantro", "Comino"], instructions: ["Sofr√≠e cebolla y ajo", "A√±ade carne", "Sazona con comino", "Sirve en lechuga", "Corona con tomate"] },
            { id: 6, name: "Pollo al curry con coliflor", category: "cena", time: 35, servings: 4, carbs: 10, calories: 420, emoji: "üçõ", isGlutenFree: true, carbsLevel: "low", ingredients: ["600g pollo", "1 coliflor", "400ml leche de coco", "3 cdas curry", "1 cebolla", "Jengibre"], instructions: ["Corta y dora pollo", "Sofr√≠e cebolla y jengibre", "A√±ade curry", "Vierte leche de coco y coliflor", "Cocina 20 min"] },
            { id: 7, name: "Rollitos de jam√≥n y queso crema", category: "snack", time: 5, servings: 2, carbs: 2, calories: 180, emoji: "üßÄ", isGlutenFree: true, carbsLevel: "low", ingredients: ["6 fetas jam√≥n", "100g queso crema", "Ceboll√≠n", "Pimienta"], instructions: ["Mezcla queso con ceboll√≠n", "Unta sobre jam√≥n", "Enrolla", "Refrigera 10 min"] },
            { id: 8, name: "Zoodles con pesto", category: "almuerzo", time: 15, servings: 2, carbs: 8, calories: 290, emoji: "üçù", isGlutenFree: true, carbsLevel: "low", ingredients: ["3 zucchinis", "4 cdas pesto sin gluten", "Tomates cherry", "Parmesano", "Pi√±ones"], instructions: ["Espirala zucchinis", "Saltea 2 min", "Mezcla con pesto", "A√±ade tomates", "Sirve con parmesano"] },
            { id: 9, name: "Costillas de cerdo", category: "cena", time: 45, servings: 4, carbs: 5, calories: 580, emoji: "üçñ", isGlutenFree: true, carbsLevel: "low", ingredients: ["1kg costillas", "Salsa BBQ sin az√∫car", "Ensalada mixta", "Aceite de oliva", "Vinagre"], instructions: ["Sazona y hornea 30 min", "Unta con salsa BBQ", "Hornea 15 min m√°s", "Prepara ensalada", "Sirve junto"] },
            { id: 10, name: "Chips de kale", category: "snack", time: 20, servings: 4, carbs: 3, calories: 90, emoji: "ü•¨", isGlutenFree: true, carbsLevel: "low", ingredients: ["1 manojo kale", "Aceite de oliva", "Sal marina", "Ajo en polvo"], instructions: ["Precalienta 150¬∞C", "Lava y seca kale", "Quita tallos", "Mezcla con aceite", "Hornea 15-20 min"] },
            { id: 11, name: "Pancakes de almendra", category: "desayuno", time: 20, servings: 2, carbs: 6, calories: 340, emoji: "ü•û", isGlutenFree: true, carbsLevel: "low", ingredients: ["1 taza harina almendra", "2 huevos", "2 cdas crema", "Polvo hornear", "Vainilla"], instructions: ["Mezcla ingredientes secos", "A√±ade huevos y crema", "Calienta sart√©n", "Vierte porciones", "Cocina 2-3 min por lado"] },
            { id: 12, name: "Ensalada griega", category: "almuerzo", time: 10, servings: 2, carbs: 7, calories: 320, emoji: "ü•í", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 pepinos", "4 tomates", "1 cebolla morada", "200g queso feta", "Aceitunas", "Or√©gano"], instructions: ["Corta pepinos y tomates", "Rebana cebolla", "Combina todo", "A√±ade feta y aceitunas", "Ali√±a con aceite"] },
            { id: 13, name: "Wrap de lechuga con at√∫n", category: "almuerzo", time: 10, servings: 2, carbs: 4, calories: 280, emoji: "üêü", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 latas at√∫n", "4 hojas lechuga", "2 cdas mayonesa", "Apio", "Lim√≥n"], instructions: ["Escurre at√∫n", "Mezcla con mayonesa y apio", "Sazona", "Coloca en lechuga", "Enrolla"] },
            { id: 14, name: "Brochetas de camar√≥n", category: "cena", time: 25, servings: 4, carbs: 3, calories: 220, emoji: "üç§", isGlutenFree: true, carbsLevel: "low", ingredients: ["500g camarones", "2 pimientos", "1 calabac√≠n", "Aceite de oliva", "Ajo y lim√≥n"], instructions: ["Marina camarones", "Corta vegetales", "Ensarta en palitos", "Cocina a la parrilla", "Sirve con perejil"] },
            { id: 15, name: "Mousse de chocolate keto", category: "snack", time: 15, servings: 4, carbs: 4, calories: 250, emoji: "üç´", isGlutenFree: true, carbsLevel: "low", ingredients: ["200ml crema", "50g chocolate 85%", "Eritritol", "Vainilla"], instructions: ["Derrite chocolate", "Bate crema", "Incorpora chocolate", "A√±ade eritritol", "Refrigera 2 horas"] },
            { id: 16, name: "Tortilla espa√±ola sin papa", category: "desayuno", time: 25, servings: 4, carbs: 5, calories: 290, emoji: "üç≥", isGlutenFree: true, carbsLevel: "low", ingredients: ["8 huevos", "2 calabacines", "1 cebolla", "Aceite de oliva", "Sal"], instructions: ["Corta vegetales", "Sofr√≠e hasta dorar", "Bate huevos", "Vierte sobre vegetales", "Voltea para dorar"] },
            { id: 17, name: "Pollo con chimichurri", category: "cena", time: 20, servings: 2, carbs: 2, calories: 380, emoji: "üçó", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 pechugas", "Perejil", "Or√©gano", "Ajo", "Aceite de oliva", "Vinagre"], instructions: ["Aplana pechugas", "Cocina a la plancha", "Pica hierbas y ajo", "Mezcla con aceite y vinagre", "Sirve con chimichurri"] },
            { id: 18, name: "Crema de calabaza", category: "cena", time: 30, servings: 4, carbs: 12, calories: 180, emoji: "üéÉ", isGlutenFree: true, carbsLevel: "low", ingredients: ["1 calabaza", "1 cebolla", "Ajo", "Caldo de pollo", "Crema", "Nuez moscada"], instructions: ["Pela y corta calabaza", "Sofr√≠e cebolla y ajo", "A√±ade calabaza y caldo", "Cocina hasta tierna", "Lic√∫a y sirve"] },
            { id: 19, name: "Alb√≥ndigas de pavo", category: "cena", time: 35, servings: 4, carbs: 6, calories: 340, emoji: "üçù", isGlutenFree: true, carbsLevel: "low", ingredients: ["500g pavo molido", "1 huevo", "Harina de almendra", "Salsa de tomate", "Hierbas"], instructions: ["Mezcla pavo con huevo", "Forma alb√≥ndigas", "Dora en sart√©n", "Prepara salsa", "Cocina 15 min en salsa"] },
            { id: 20, name: "Aguacates rellenos de camar√≥n", category: "almuerzo", time: 15, servings: 2, carbs: 6, calories: 380, emoji: "ü•ë", isGlutenFree: true, carbsLevel: "low", ingredients: ["2 aguacates", "200g camarones", "Mayonesa", "Lim√≥n", "Cilantro"], instructions: ["Corta aguacates", "Pica camarones", "Mezcla con mayonesa", "Rellena aguacates", "Decora con cilantro"] }
        ];

        let recipes = [...baseRecipes], searchResults = [], weekMenu = {}, shoppingList = [], currentRecipe = null, selectedDay = null, isSearchMode = false;
        const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        const daysLong = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        const STORAGE_KEY = 'glutenfree_kitchen_data';

        // Ingredientes con gluten a detectar
        const glutenIngredients = ['flour', 'wheat', 'bread', 'pasta', 'noodle', 'barley', 'rye', 'oat', 'beer', 'seitan', 'bulgur', 'couscous', 'semolina', 'cracker', 'breadcrumb', 'breaded', 'tortilla', 'pizza', 'soy sauce', 'harina', 'trigo', 'pan', 'fideos', 'cebada', 'centeno', 'avena', 'cerveza', 'galleta', 'empanizado', 'rebozado'];
        
        // Ingredientes altos en carbs
        const highCarbIngredients = ['potato', 'rice', 'corn', 'sugar', 'honey', 'banana', 'grape', 'mango', 'pineapple', 'beans', 'lentil', 'chickpea', 'quinoa', 'sweet potato', 'yuca', 'papa', 'arroz', 'ma√≠z', 'az√∫car', 'miel', 'pl√°tano', 'uva', 'pi√±a', 'frijol', 'lenteja', 'garbanzo', 'batata', 'camote'];

        const emojiMap = { 'chicken': 'üçó', 'pollo': 'üçó', 'beef': 'ü•©', 'carne': 'ü•©', 'pork': 'ü•ì', 'cerdo': 'ü•ì', 'fish': 'üêü', 'salmon': 'üêü', 'tuna': 'üêü', 'pescado': 'üêü', 'shrimp': 'üç§', 'camar√≥n': 'üç§', 'egg': 'üç≥', 'huevo': 'üç≥', 'salad': 'ü•ó', 'ensalada': 'ü•ó', 'soup': 'üç≤', 'sopa': 'üç≤', 'avocado': 'ü•ë', 'aguacate': 'ü•ë', 'cheese': 'üßÄ', 'queso': 'üßÄ', 'default': 'üçΩÔ∏è' };

        document.addEventListener('DOMContentLoaded', () => { loadData(); renderRecipes(); renderWeekSelector(); renderMealSlots(); renderShoppingList(); setupEventListeners(); });

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ weekMenu, shoppingList, savedRecipes: recipes.filter(r => r.fromSearch), lastUpdated: new Date().toISOString() })); }
        
        function loadData() { 
            const saved = localStorage.getItem(STORAGE_KEY); 
            if (saved) { 
                const data = JSON.parse(saved); 
                weekMenu = data.weekMenu || {}; 
                shoppingList = data.shoppingList || []; 
                if (data.savedRecipes) recipes = [...baseRecipes, ...data.savedRecipes]; 
            } 
        }
        
        function getRecipeEmoji(name) { 
            const lowerName = name.toLowerCase(); 
            for (const [kw, emoji] of Object.entries(emojiMap)) { 
                if (lowerName.includes(kw)) return emoji; 
            } 
            return emojiMap.default; 
        }
        
        function analyzeRecipe(ingredients) { 
            const lowerIngs = ingredients.map(i => i.toLowerCase()).join(' '); 
            let hasGluten = false, highCarbItems = [], estimatedCarbs = 5; 
            
            for (const g of glutenIngredients) { 
                if (lowerIngs.includes(g)) { hasGluten = true; break; } 
            } 
            for (const c of highCarbIngredients) { 
                if (lowerIngs.includes(c)) { highCarbItems.push(c); estimatedCarbs += 15; } 
            } 
            
            return { 
                isGlutenFree: !hasGluten, 
                highCarbItems, 
                estimatedCarbs: Math.min(estimatedCarbs, 50), 
                carbsLevel: estimatedCarbs <= 15 ? 'low' : estimatedCarbs <= 30 ? 'medium' : 'high' 
            }; 
        }

        // B√∫squeda usando TheMealDB API (gratuita y sin CORS)
        async function searchRecipes(query) {
            const loadingContainer = document.getElementById('loadingContainer');
            loadingContainer.classList.add('active');
            updateLoadingStep('search');
            
            try {
                // TheMealDB es una API gratuita sin problemas de CORS
                const response = await fetch(`https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                updateLoadingStep('analyze');
                
                if (!data.meals) {
                    loadingContainer.classList.remove('active');
                    showToast('No se encontraron recetas. Prob√° otro t√©rmino.', 'error');
                    return;
                }

                updateLoadingStep('filter');
                
                // Procesar y analizar cada receta
                const processedRecipes = data.meals.map((meal, i) => {
                    // Extraer ingredientes
                    const ingredients = [];
                    for (let j = 1; j <= 20; j++) {
                        const ing = meal[`strIngredient${j}`];
                        const measure = meal[`strMeasure${j}`];
                        if (ing && ing.trim()) {
                            ingredients.push(`${measure ? measure.trim() + ' ' : ''}${ing.trim()}`);
                        }
                    }
                    
                    // Extraer instrucciones
                    const instructions = meal.strInstructions
                        ? meal.strInstructions.split(/\r\n|\n|\r/).filter(s => s.trim().length > 0).slice(0, 8)
                        : ['Ver instrucciones completas en el enlace'];
                    
                    const analysis = analyzeRecipe(ingredients);
                    
                    // Determinar categor√≠a basada en tags o categor√≠a de la API
                    let category = 'almuerzo';
                    const mealCategory = (meal.strCategory || '').toLowerCase();
                    if (mealCategory.includes('breakfast') || mealCategory.includes('starter')) category = 'desayuno';
                    else if (mealCategory.includes('dessert') || mealCategory.includes('side')) category = 'snack';
                    else if (mealCategory.includes('beef') || mealCategory.includes('pork') || mealCategory.includes('lamb')) category = 'cena';
                    
                    return {
                        id: Date.now() + i,
                        name: meal.strMeal,
                        category,
                        time: 30,
                        servings: 4,
                        carbs: analysis.estimatedCarbs,
                        calories: 350,
                        emoji: getRecipeEmoji(meal.strMeal),
                        image: meal.strMealThumb,
                        isGlutenFree: analysis.isGlutenFree,
                        carbsLevel: analysis.carbsLevel,
                        highCarbItems: analysis.highCarbItems,
                        ingredients,
                        instructions,
                        source: meal.strSource || 'TheMealDB',
                        fromSearch: true
                    };
                });
                
                // Filtrar solo las aptas (sin gluten y no alto en carbs)
                const aptRecipes = processedRecipes.filter(r => r.isGlutenFree && r.carbsLevel !== 'high');
                const notAptCount = processedRecipes.length - aptRecipes.length;
                
                searchResults = aptRecipes;
                recipes = [...aptRecipes, ...baseRecipes];
                
                loadingContainer.classList.remove('active');
                isSearchMode = true;
                
                document.getElementById('searchResultsInfo').classList.add('active');
                document.getElementById('resultsTitle').textContent = `Resultados para "${query}"`;
                document.getElementById('resultsDescription').textContent = 
                    `${aptRecipes.length} recetas aptas encontradas. ${notAptCount > 0 ? `(${notAptCount} descartadas por gluten o carbs altos)` : ''}`;
                
                renderRecipes();
                saveData();
                
                showToast(aptRecipes.length > 0 ? `${aptRecipes.length} recetas aptas encontradas` : 'No se encontraron recetas aptas', aptRecipes.length > 0 ? 'success' : '');
                
            } catch (error) { 
                console.error(error); 
                loadingContainer.classList.remove('active'); 
                showToast('Error al buscar. Intent√° de nuevo.', 'error'); 
            }
        }

        function updateLoadingStep(currentStep) { 
            const steps = document.querySelectorAll('.loading-step'); 
            let passed = false; 
            steps.forEach(step => { 
                step.classList.remove('done', 'active'); 
                if (step.dataset.step === currentStep) { step.classList.add('active'); passed = true; } 
                else if (!passed) step.classList.add('done'); 
            }); 
        }
        
        function renderRecipes(filter = 'all') { 
            const grid = document.getElementById('recipeGrid'); 
            let displayRecipes = isSearchMode ? recipes : baseRecipes; 
            const filtered = filter === 'all' ? displayRecipes : displayRecipes.filter(r => r.category === filter); 
            
            grid.innerHTML = filtered.map(recipe => {
                const imageStyle = recipe.image ? `background-image:url('${recipe.image}')` : '';
                const imageClass = recipe.image ? 'has-img' : '';
                
                return `<div class="recipe-card ${recipe.fromSearch ? 'from-search' : ''}" data-id="${recipe.id}">
                    <div class="recipe-image ${imageClass}" style="${imageStyle}">
                        <span>${recipe.emoji}</span>
                        <div class="recipe-badges">
                            <span class="badge">${recipe.category}</span>
                            <span class="badge carbs">${recipe.carbs}g carbs</span>
                            ${recipe.fromSearch ? '<span class="badge ai">üåê Web</span>' : ''}
                        </div>
                    </div>
                    <div class="recipe-content">
                        <h3 class="recipe-title">${recipe.name}</h3>
                        <div class="recipe-meta">
                            <span>‚è±Ô∏è ${recipe.time} min</span>
                            <span>üë• ${recipe.servings}</span>
                            <span>üî• ${recipe.calories} kcal</span>
                        </div>
                        ${recipe.fromSearch ? `<div class="recipe-analysis">
                            <div class="analysis-item"><span>Gluten:</span><span class="analysis-value good">‚úì Libre</span></div>
                            <div class="analysis-item"><span>Carbs:</span><span class="analysis-value ${recipe.carbsLevel === 'low' ? 'good' : 'warning'}">${recipe.carbsLevel === 'low' ? '‚úì Bajo' : '‚ö† Medio'}</span></div>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join(''); 
        }
        
        function renderWeekSelector() { 
            const selector = document.getElementById('weekSelector'); 
            const today = new Date(); 
            const startOfWeek = new Date(today); 
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); 
            
            selector.innerHTML = days.map((day, i) => { 
                const date = new Date(startOfWeek); 
                date.setDate(startOfWeek.getDate() + i); 
                const dayKey = `day_${i}`; 
                const hasMeals = weekMenu[dayKey] && Object.keys(weekMenu[dayKey]).length > 0; 
                const isSelected = selectedDay === i || (selectedDay === null && i === 0); 
                return `<button class="day-btn ${isSelected ? 'active' : ''} ${hasMeals ? 'has-meals' : ''}" data-day="${i}"><div class="day-name">${day}</div><div class="day-number">${date.getDate()}</div></button>`; 
            }).join(''); 
            if (selectedDay === null) selectedDay = 0; 
        }
        
        function renderMealSlots() { 
            const slots = document.getElementById('mealSlots'); 
            const dayKey = `day_${selectedDay}`; 
            const dayMeals = weekMenu[dayKey] || {}; 
            const mealTypes = [{ key: 'desayuno', name: 'Desayuno', icon: 'üåÖ' }, { key: 'almuerzo', name: 'Almuerzo', icon: '‚òÄÔ∏è' }, { key: 'cena', name: 'Cena', icon: 'üåô' }]; 
            
            slots.innerHTML = mealTypes.map(meal => { 
                const mealData = dayMeals[meal.key]; 
                return `<div class="meal-slot"><div class="meal-slot-header"><span class="meal-type"><span>${meal.icon}</span>${meal.name}</span></div>${mealData ? `<div class="meal-item"><span class="meal-item-name">${mealData.name}</span><button class="remove-meal" data-day="${selectedDay}" data-meal="${meal.key}">√ó</button></div>` : `<div class="empty-slot">Toca una receta y agr√©gala aqu√≠</div>`}</div>`; 
            }).join(''); 
        }
        
        function renderShoppingList() { 
            const container = document.getElementById('shoppingCategories'); 
            if (shoppingList.length === 0) { 
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üõí</div><p class="empty-state-text">Tu lista est√° vac√≠a.<br>Planifica tu men√∫ y genera la lista.</p></div>`; 
                updateProgress(); 
                return; 
            } 
            
            const categories = { 'prote√≠nas': { icon: 'ü•©', items: [] }, 'vegetales': { icon: 'ü•¨', items: [] }, 'l√°cteos': { icon: 'üßÄ', items: [] }, 'otros': { icon: 'üõí', items: [] } }; 
            const proteinKw = ['pollo', 'carne', 'salm√≥n', 'huevo', 'jam√≥n', 'cerdo', 'pescado', 'at√∫n', 'camar√≥n', 'pavo', 'chicken', 'beef', 'pork', 'fish', 'egg', 'shrimp', 'turkey', 'salmon', 'tuna']; 
            const veggieKw = ['lechuga', 'tomate', 'cebolla', 'esp√°rrago', 'espinaca', 'coliflor', 'pepino', 'aguacate', 'zucchini', 'kale', 'pimiento', 'calabac√≠n', 'apio', 'calabaza', 'lettuce', 'tomato', 'onion', 'asparagus', 'spinach', 'cauliflower', 'cucumber', 'avocado', 'pepper', 'celery']; 
            const dairyKw = ['queso', 'mantequilla', 'crema', 'leche', 'parmesano', 'feta', 'cheese', 'butter', 'cream', 'milk']; 
            
            shoppingList.forEach(item => { 
                const name = item.name.toLowerCase(); 
                if (proteinKw.some(k => name.includes(k))) categories['prote√≠nas'].items.push(item); 
                else if (veggieKw.some(k => name.includes(k))) categories['vegetales'].items.push(item); 
                else if (dairyKw.some(k => name.includes(k))) categories['l√°cteos'].items.push(item); 
                else categories['otros'].items.push(item); 
            }); 
            
            container.innerHTML = Object.entries(categories).filter(([_, cat]) => cat.items.length > 0).map(([name, cat]) => `<div class="shopping-category"><div class="category-header"><span class="category-icon">${cat.icon}</span>${name.charAt(0).toUpperCase() + name.slice(1)}</div><div class="shopping-items">${cat.items.map(item => `<div class="shopping-item ${item.checked ? 'checked' : ''}" data-id="${item.id}"><div class="checkbox"><span class="checkbox-icon">‚úì</span></div><div class="item-name">${item.name}</div></div>`).join('')}</div></div>`).join(''); 
            updateProgress(); 
        }
        
        function updateProgress() { 
            const total = shoppingList.length; 
            const checked = shoppingList.filter(i => i.checked).length; 
            const percent = total > 0 ? (checked / total) * 100 : 0; 
            document.getElementById('progressFill').style.width = `${percent}%`; 
            document.getElementById('progressText').textContent = `${checked} de ${total} items`; 
        }
        
        function setupEventListeners() { 
            document.querySelectorAll('.nav-tab').forEach(tab => { 
                tab.addEventListener('click', () => { 
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); 
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
                    tab.classList.add('active'); 
                    document.getElementById(tab.dataset.tab).classList.add('active'); 
                }); 
            }); 
            
            document.querySelectorAll('.filter-chip').forEach(chip => { 
                chip.addEventListener('click', () => { 
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); 
                    chip.classList.add('active'); 
                    renderRecipes(chip.dataset.filter); 
                }); 
            }); 
            
            document.getElementById('searchBtn').addEventListener('click', () => { 
                const query = document.getElementById('searchInput').value.trim(); 
                if (query) searchRecipes(query); 
            }); 
            
            document.getElementById('searchInput').addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') { 
                    const query = e.target.value.trim(); 
                    if (query) searchRecipes(query); 
                } 
            }); 
            
            document.querySelectorAll('.suggestion-chip').forEach(chip => { 
                chip.addEventListener('click', () => { 
                    document.getElementById('searchInput').value = chip.dataset.query; 
                    searchRecipes(chip.dataset.query); 
                }); 
            }); 
            
            document.getElementById('clearSearchBtn').addEventListener('click', () => { 
                isSearchMode = false; 
                document.getElementById('searchResultsInfo').classList.remove('active'); 
                document.getElementById('searchInput').value = ''; 
                renderRecipes(); 
            }); 
            
            document.getElementById('recipeGrid').addEventListener('click', (e) => { 
                const card = e.target.closest('.recipe-card'); 
                if (card) openRecipeModal(parseInt(card.dataset.id)); 
            }); 
            
            document.getElementById('weekSelector').addEventListener('click', (e) => { 
                const btn = e.target.closest('.day-btn'); 
                if (btn) { selectedDay = parseInt(btn.dataset.day); renderWeekSelector(); renderMealSlots(); } 
            }); 
            
            document.getElementById('mealSlots').addEventListener('click', (e) => { 
                if (e.target.classList.contains('remove-meal')) { 
                    const day = e.target.dataset.day, meal = e.target.dataset.meal; 
                    if (weekMenu[`day_${day}`]) { delete weekMenu[`day_${day}`][meal]; saveData(); renderMealSlots(); renderWeekSelector(); showToast('Receta eliminada'); } 
                } 
            }); 
            
            document.getElementById('closeModal').addEventListener('click', closeRecipeModal); 
            document.getElementById('recipeModal').addEventListener('click', (e) => { if (e.target.id === 'recipeModal') closeRecipeModal(); }); 
            document.getElementById('addToMenuBtn').addEventListener('click', () => { closeRecipeModal(); openDaySelectModal(); }); 
            document.getElementById('closeDayModal').addEventListener('click', closeDaySelectModal); 
            document.getElementById('daySelectModal').addEventListener('click', (e) => { if (e.target.id === 'daySelectModal') closeDaySelectModal(); }); 
            
            document.getElementById('mealSelectBtns').addEventListener('click', (e) => { 
                const btn = e.target.closest('.meal-select-btn'); 
                if (btn && selectedDay !== null && currentRecipe) { 
                    const mealType = btn.dataset.meal, dayKey = `day_${selectedDay}`; 
                    if (!weekMenu[dayKey]) weekMenu[dayKey] = {}; 
                    weekMenu[dayKey][mealType] = { id: currentRecipe.id, name: currentRecipe.name, ingredients: currentRecipe.ingredients }; 
                    saveData(); closeDaySelectModal(); renderWeekSelector(); renderMealSlots(); 
                    showToast(`${currentRecipe.name} agregado`, 'success'); 
                } 
            }); 
            
            document.getElementById('generateListBtn').addEventListener('click', generateShoppingList); 
            
            document.getElementById('shoppingCategories').addEventListener('click', (e) => { 
                const item = e.target.closest('.shopping-item'); 
                if (item) { 
                    const listItem = shoppingList.find(i => i.id === item.dataset.id); 
                    if (listItem) { listItem.checked = !listItem.checked; saveData(); renderShoppingList(); } 
                } 
            }); 
            
            document.getElementById('addItemBtn').addEventListener('click', addManualItem); 
            document.getElementById('addItemInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addManualItem(); }); 
        }
        
        function openRecipeModal(id) { 
            currentRecipe = recipes.find(r => r.id === id); 
            if (!currentRecipe) return; 
            
            document.getElementById('modalTitle').textContent = currentRecipe.name; 
            
            let alertHtml = ''; 
            if (currentRecipe.fromSearch && currentRecipe.highCarbItems?.length > 0) { 
                alertHtml = `<div class="gluten-alert"><span class="gluten-alert-icon">‚ö†Ô∏è</span><div class="gluten-alert-text"><div class="gluten-alert-title">Ingredientes con m√°s carbohidratos detectados</div>${currentRecipe.highCarbItems.join(', ')} - Pod√©s reducirlos o sustituirlos</div></div>`; 
            } 
            
            const imageStyle = currentRecipe.image ? `background-image:url('${currentRecipe.image}')` : '';
            
            document.getElementById('modalBody').innerHTML = `
                <div class="recipe-detail-image" style="${imageStyle}">${!currentRecipe.image ? currentRecipe.emoji : ''}</div>
                ${alertHtml}
                <div class="recipe-detail-badges">
                    <span class="detail-badge">‚è±Ô∏è ${currentRecipe.time} min</span>
                    <span class="detail-badge">üë• ${currentRecipe.servings} porc.</span>
                    <span class="detail-badge">üî• ${currentRecipe.calories} kcal</span>
                    <span class="detail-badge">üçû ${currentRecipe.carbs}g carbs</span>
                    ${currentRecipe.fromSearch ? '<span class="detail-badge">‚úì Sin gluten</span>' : ''}
                </div>
                <div class="recipe-section"><h4 class="recipe-section-title">Ingredientes</h4><ul class="ingredients-list">${currentRecipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul></div>
                <div class="recipe-section"><h4 class="recipe-section-title">Preparaci√≥n</h4><ol class="instructions-list">${currentRecipe.instructions.map((inst, i) => `<li><span class="step-number">${i + 1}</span><span>${inst}</span></li>`).join('')}</ol></div>
            `; 
            document.getElementById('recipeModal').classList.add('active'); 
        }
        
        function closeRecipeModal() { document.getElementById('recipeModal').classList.remove('active'); }
        
        function openDaySelectModal() { 
            const grid = document.getElementById('daySelectGrid'); 
            grid.innerHTML = days.map((day, i) => `<button class="day-select-btn ${selectedDay === i ? 'selected' : ''}" data-day="${i}">${daysLong[i]}</button>`).join(''); 
            grid.querySelectorAll('.day-select-btn').forEach(btn => { 
                btn.addEventListener('click', () => { 
                    grid.querySelectorAll('.day-select-btn').forEach(b => b.classList.remove('selected')); 
                    btn.classList.add('selected'); 
                    selectedDay = parseInt(btn.dataset.day); 
                }); 
            }); 
            document.getElementById('daySelectModal').classList.add('active'); 
        }
        
        function closeDaySelectModal() { document.getElementById('daySelectModal').classList.remove('active'); }
        
        function generateShoppingList() { 
            shoppingList = []; 
            const ingredientMap = new Map(); 
            Object.values(weekMenu).forEach(dayMeals => { 
                Object.values(dayMeals).forEach(meal => { 
                    if (meal.ingredients) { 
                        meal.ingredients.forEach(ing => { 
                            const key = ing.toLowerCase(); 
                            if (!ingredientMap.has(key)) { 
                                ingredientMap.set(key, { id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, name: ing, checked: false }); 
                            } 
                        }); 
                    } 
                }); 
            }); 
            shoppingList = Array.from(ingredientMap.values()); 
            saveData(); 
            renderShoppingList(); 
            showToast(shoppingList.length > 0 ? `Lista generada: ${shoppingList.length} items` : 'Agrega recetas al men√∫ primero', shoppingList.length > 0 ? 'success' : ''); 
        }
        
        function addManualItem() { 
            const input = document.getElementById('addItemInput'); 
            const name = input.value.trim(); 
            if (name) { 
                shoppingList.push({ id: `item_${Date.now()}`, name, checked: false }); 
                saveData(); 
                renderShoppingList(); 
                input.value = ''; 
                showToast('Item agregado', 'success'); 
            } 
        }
        
        function showToast(message, type = '') { 
            const toast = document.getElementById('toast'); 
            toast.textContent = message; 
            toast.className = 'toast'; 
            if (type) toast.classList.add(type); 
            toast.classList.add('show'); 
            setTimeout(() => toast.classList.remove('show'), 2500); 
        }
    </script>
</body>
</html>
